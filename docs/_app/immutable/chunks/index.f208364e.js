import{S as Kl,i as Ul,s as Ll,k as i,q as t,a as c,H as y,T as bo,l as p,m as n,r as l,h as e,c as k,D as v,U as xo,n as h,b as r,E as o,F as bt}from"./index.ebf6ac20.js";function Wl(xl){let w,wo,M,_o,Eo,Ae,A,qo,B,Po,To,Ce,u,G,es,Ao,Co,Do,qs,Io,So,Ps,go,No,os,Ho,$o,Ts,Oo,Ro,As,jo,Ko,De,Cs,wl=`<pre class="shiki   language-yaml"><code tabindex="0"><span class="line"><span style="color: var(--shiki-token-parameter)">apiVersion</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">admissionregistration.k8s.io/v1</span></span>
<span class="line"><span style="color: var(--shiki-token-parameter)">kind</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">MutatingWebhookConfiguration</span></span>
<span class="line"><span style="color: var(--shiki-token-parameter)">metadata</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-parameter)">name</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">webhook</span></span>
<span class="line"><span style="color: var(--shiki-token-parameter)">webhooks</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  - </span><span style="color: var(--shiki-token-parameter)">name</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">webhook</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-parameter)">clientConfig</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-parameter)">service</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-parameter)">name</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">controller</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-parameter)">namespace</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">admission</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-parameter)">path</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">/mutate</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-parameter)">rules</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      - </span><span style="color: var(--shiki-token-parameter)">apiGroups</span><span style="color: var(--shiki-color-text)">: [</span><span style="color: var(--shiki-token-string)">&quot;&quot;</span><span style="color: var(--shiki-color-text)">]</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-parameter)">apiVersions</span><span style="color: var(--shiki-color-text)">: [</span><span style="color: var(--shiki-token-string)">&quot;v1&quot;</span><span style="color: var(--shiki-color-text)">]</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-parameter)">resources</span><span style="color: var(--shiki-color-text)">: [</span><span style="color: var(--shiki-token-string)">&quot;pods&quot;</span><span style="color: var(--shiki-color-text)">]</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-parameter)">operations</span><span style="color: var(--shiki-color-text)">: [</span><span style="color: var(--shiki-token-string)">&quot;CREATE&quot;</span><span style="color: var(--shiki-color-text)">, </span><span style="color: var(--shiki-token-string)">&quot;UPDATE&quot;</span><span style="color: var(--shiki-color-text)">]</span></span></code></pre>`,Ds,m,Uo,Is,Lo,Wo,Ss,Mo,Bo,gs,Go,Vo,V,Fo,Zo,Ie,d,x,as,zo,Jo,Ns,Qo,Xo,Hs,Yo,sa,ea,ts,oa,aa,$s,ta,la,F,ra,na,Se,ls,ia,ge,b,Z,rs,pa,ca,ka,z,ha,ns,ya,va,J,ua,ma,Ne,C,q,D,Os,da,He,is,fa,$e,I,ba,Q,xa,wa,Oe,S,_a,X,Ea,qa,Re,g,Pa,Rs,Ta,Aa,je,js,_l=`<pre class="shiki   language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ curl </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">L </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">o kubebuilder https:</span><span style="color: var(--shiki-token-symbol)">//</span><span style="color: var(--shiki-color-text)">go.kubebuilder.io</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">dl</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-token-numeric)">3.2</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-numeric)">0</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-token-keyword)">$</span><span style="color: var(--shiki-color-text)">(go env GOOS)</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-token-keyword)">$</span><span style="color: var(--shiki-color-text)">(go env GOARCH)</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">$ chmod </span><span style="color: var(--shiki-token-symbol)">+</span><span style="color: var(--shiki-color-text)">x kubebuilder &amp;&amp; mv kubebuilder </span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">usr</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">local</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">bin</span><span style="color: var(--shiki-token-symbol)">/</span></span></code></pre>`,Ks,ps,Ca,Ke,Us,El=`<pre class="shiki   language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ mkdir webhook &amp;&amp; cd webhook</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">$ kubebuilder init </span><span style="color: var(--shiki-token-symbol)">--</span><span style="color: var(--shiki-color-text)">repo </span><span style="color: var(--shiki-token-symbol)">github.com/</span><span style="color: var(--shiki-color-text)">user</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">webhook</span></span></code></pre>`,Ls,N,Da,Ws,Ia,Sa,Ue,Ms,ql=`<pre class="shiki   language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ kubebuilder create api </span><span style="color: var(--shiki-token-symbol)">--</span><span style="color: var(--shiki-color-text)">version v1 </span><span style="color: var(--shiki-token-symbol)">--</span><span style="color: var(--shiki-color-text)">kind Hooked</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">$ kubebuilder create webhook </span><span style="color: var(--shiki-token-symbol)">--</span><span style="color: var(--shiki-color-text)">version v1 </span><span style="color: var(--shiki-token-symbol)">--</span><span style="color: var(--shiki-color-text)">kind Hooked </span><span style="color: var(--shiki-token-symbol)">--</span><span style="color: var(--shiki-color-text)">defaulting</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">$ make manifests</span></span></code></pre>`,Bs,H,ga,Y,Na,Ha,Le,cs,$a,We,Gs,Pl='<pre class="shiki   language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ kubectl apply </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">k config</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">crd</span></span></code></pre>',Vs,ks,Oa,Me,Fs,Tl=`<pre class="shiki   language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ kubectl create ns webhook</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">$ kubectl config </span><span style="color: var(--shiki-token-symbol)">set-context</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-symbol)">--</span><span style="color: var(--shiki-color-text)">current </span><span style="color: var(--shiki-token-symbol)">--</span><span style="color: var(--shiki-color-text)">namespace</span><span style="color: var(--shiki-token-symbol)">=</span><span style="color: var(--shiki-color-text)">webhook</span></span></code></pre>`,Zs,hs,Ra,Be,zs,Al=`<pre class="shiki   language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ </span><span style="color: var(--shiki-token-keyword)">$</span><span style="color: var(--shiki-color-text)">(cd config</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">webhook &amp;&amp; kustomize edit set namespace webhook)</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">$ kubectl apply </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">k config</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">webhook</span></span></code></pre>`,Js,$,ja,Qs,Ka,Ua,Ge,Xs,Cl=`<pre class="shiki   language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ kubectl apply </span><span style="color: var(--shiki-color-text)">-f</span><span style="color: var(--shiki-color-text)"> config</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">samples</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">_v1_hooked.yaml</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  Error </span><span style="color: var(--shiki-token-keyword)">from</span><span style="color: var(--shiki-color-text)"> server (InternalError): error when creating </span><span style="color: var(--shiki-token-string)">&quot;config/samples/_v1_hooked.yaml&quot;</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  Internal error occurred: failed calling webhook </span><span style="color: var(--shiki-token-string)">&quot;mhooked.kb.io&quot;</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    Post </span><span style="color: var(--shiki-token-string)">&quot;https://webhook-service.webhook.svc:443/mutate-my-domain-v1-hooked?timeout=10s&quot;</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      no endpoints available </span><span style="color: var(--shiki-token-keyword)">for</span><span style="color: var(--shiki-color-text)"> service </span><span style="color: var(--shiki-token-string)">&quot;webhook-service&quot;</span></span></code></pre>`,Ys,O,La,se,Wa,Ma,Ve,ys,Ba,Fe,R,P,j,ee,Ga,Ze,vs,Va,ze,K,Fa,oe,Za,za,Je,ae,Dl='<pre class="shiki   language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ curl </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">fL https:</span><span style="color: var(--shiki-token-symbol)">//</span><span style="color: var(--shiki-color-text)">app.getambassador.io</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">download</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">tel2</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">darwin</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">amd64</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-token-numeric)">2.4</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-numeric)">9</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">telepresence </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">o </span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">usr</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">local</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">bin</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">telepresence</span></span></code></pre>',te,us,Ja,Qe,le,Il=`<pre class="shiki   language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ telepresence connect</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">Launching Telepresence Root Daemon</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">Launching Telepresence User Daemon</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">$ telepresence status</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">Root Daemon: Running</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  Version   : v2.</span><span style="color: var(--shiki-token-numeric)">4.9</span><span style="color: var(--shiki-color-text)"> (api </span><span style="color: var(--shiki-token-numeric)">3</span><span style="color: var(--shiki-color-text)">)</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  DNS       :</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    Remote IP       : REDACTED</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    Exclude suffixes: [.</span><span style="color: var(--shiki-token-keyword)">arpa</span><span style="color: var(--shiki-color-text)"> .</span><span style="color: var(--shiki-token-keyword)">com</span><span style="color: var(--shiki-color-text)"> .</span><span style="color: var(--shiki-token-keyword)">io</span><span style="color: var(--shiki-color-text)"> .</span><span style="color: var(--shiki-token-keyword)">net</span><span style="color: var(--shiki-color-text)"> .</span><span style="color: var(--shiki-token-keyword)">org</span><span style="color: var(--shiki-color-text)"> .</span><span style="color: var(--shiki-token-keyword)">ru</span><span style="color: var(--shiki-color-text)">]</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    Include suffixes: []</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    Timeout         : 4s</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  Also Proxy : (</span><span style="color: var(--shiki-token-numeric)">0</span><span style="color: var(--shiki-color-text)"> subnets)</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  Never Proxy: (</span><span style="color: var(--shiki-token-numeric)">1</span><span style="color: var(--shiki-color-text)"> subnets)</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">User Daemon: Running</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  Version           : v2.</span><span style="color: var(--shiki-token-numeric)">4.9</span><span style="color: var(--shiki-color-text)"> (api </span><span style="color: var(--shiki-token-numeric)">3</span><span style="color: var(--shiki-color-text)">)</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  Ambassador Cloud  : Logged out</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  Status            : Connected</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  Kubernetes server : REDACTED</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  Kubernetes context: REDACTED</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  Telepresence proxy: ON (networking to the cluster is enabled)</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  Intercepts        : </span><span style="color: var(--shiki-token-numeric)">0</span><span style="color: var(--shiki-color-text)"> total</span></span></code></pre>`,re,U,Qa,ne,Xa,Ya,Xe,ie,Sl=`<pre class="shiki   language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ kubectl create deployment webhook </span><span style="color: var(--shiki-token-symbol)">--</span><span style="color: var(--shiki-color-text)">image</span><span style="color: var(--shiki-token-symbol)">=</span><span style="color: var(--shiki-color-text)">k8s.gcr.io</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">echoserver:</span><span style="color: var(--shiki-token-numeric)">1.10</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-symbol)">--</span><span style="color: var(--shiki-color-text)">port </span><span style="color: var(--shiki-token-numeric)">9443</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">$ kubectl set selector svc webhook</span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">service app</span><span style="color: var(--shiki-token-symbol)">=</span><span style="color: var(--shiki-color-text)">webhook</span></span></code></pre>`,pe,ms,st,Ye,ce,gl=`<pre class="shiki   language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ telepresence intercept webhook </span><span style="color: var(--shiki-token-symbol)">--</span><span style="color: var(--shiki-color-text)">service webhook</span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">service </span><span style="color: var(--shiki-token-symbol)">--</span><span style="color: var(--shiki-color-text)">port </span><span style="color: var(--shiki-token-numeric)">9443</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-color-text)">Using Deployment webhook</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">intercepted</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    Intercept name    : webhook</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    State             : ACTIVE</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    Workload kind     : Deployment</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    Destination       : </span><span style="color: var(--shiki-token-numeric)">127.0</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-numeric)">0.1</span><span style="color: var(--shiki-color-text)">:</span><span style="color: var(--shiki-token-numeric)">9443</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    Volume Mount Error: sshfs is not installed on your local machine</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    Intercepting      : all TCP connections</span></span></code></pre>`,ke,ds,et,so,he,Nl=`<pre class="shiki   language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-token-comment); font-style: italic"># Generate the CA certificate</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">$ openssl req </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">new </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">x509 </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">nodes </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">days </span><span style="color: var(--shiki-token-numeric)">365</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">keyout ca.key </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">out ca.crt </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">subj </span><span style="color: var(--shiki-token-string)">&quot;/CN=webhook&quot;</span></span>
<span class="line"><span style="color: var(--shiki-token-comment); font-style: italic"># Generate the webhook server certificate</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">$ openssl req </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">nodes </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">new </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">sha256 </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">keyout tls.key </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">out tls.csr </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">subj </span><span style="color: var(--shiki-token-string)">&quot;/CN=webhook-service.webhook.svc&quot;</span><span style="color: var(--shiki-color-text)"> </span></span>
<span class="line"><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">config &lt;(cat </span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">etc</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">ssl</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">openssl.cnf &lt;(printf </span><span style="color: var(--shiki-token-string)">&quot;[SAN]&#92;nsubjectAltName=DNS:webhook-service.webhook.svc&quot;</span><span style="color: var(--shiki-color-text)">)) </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">reqexts SAN</span></span>
<span class="line"><span style="color: var(--shiki-token-comment); font-style: italic"># Sign the server certificate with the generated CA</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">$ openssl x509 </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">req </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">days </span><span style="color: var(--shiki-token-numeric)">365</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-symbol)">-in</span><span style="color: var(--shiki-color-text)"> tls.csr </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">out tls.crt </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">CA ca.crt </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">CAkey ca.key </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">CAcreateserial </span></span>
<span class="line"><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">extfile &lt;(cat </span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">etc</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">ssl</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">openssl.cnf &lt;(printf </span><span style="color: var(--shiki-token-string)">&quot;[SAN]&#92;nsubjectAltName=DNS:webhook-service.webhook.svc&quot;</span><span style="color: var(--shiki-color-text)">)) </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">extensions SAN</span></span></code></pre>`,ye,_,ot,ve,at,tt,ue,lt,rt,eo,me,Hl=`<pre class="shiki   language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ kubectl patch mutatingwebhookconfiguration mutating</span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">webhook</span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">configuration </span><span style="color: var(--shiki-token-symbol)">--</span><span style="color: var(--shiki-color-text)">type</span><span style="color: var(--shiki-token-symbol)">=</span><span style="color: var(--shiki-token-string)">&#39;json&#39;</span><span style="color: var(--shiki-color-text)"> </span></span>
<span class="line"><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">p</span><span style="color: var(--shiki-token-symbol)">=</span><span style="color: var(--shiki-token-string)">&quot;[&#123;&#39;op&#39;: &#39;add&#39;, &#39;path&#39;: &#39;/webhooks/0/clientConfig/caBundle&#39;, &#39;value&#39;:&#39;</span><span style="color: var(--shiki-token-keyword)">$(</span><span style="color: var(--shiki-color-text)">cat ca.crt | base64 | tr </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">d </span><span style="color: var(--shiki-token-string)">&#39;&#92;n&#39;</span><span style="color: var(--shiki-token-keyword)">)</span><span style="color: var(--shiki-token-string)">&#39;&#125;]&quot;</span></span></code></pre>`,de,fs,nt,oo,fe,$l=`<pre class="shiki   language-go"><code tabindex="0"><span class="line"><span style="color: var(--shiki-token-variable)">mgr</span><span style="color: var(--shiki-color-text)">, </span><span style="color: var(--shiki-token-variable)">err</span><span style="color: var(--shiki-color-text)"> </span><span style="color: #E5C07B">:=</span><span style="color: var(--shiki-color-text)"> ctrl.</span><span style="color: var(--shiki-token-symbol)">NewManager</span><span style="color: var(--shiki-color-text)">(ctrl.</span><span style="color: var(--shiki-token-symbol)">GetConfigOrDie</span><span style="color: var(--shiki-color-text)">(), ctrl.Options&#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">	CertDir: </span><span style="color: var(--shiki-token-string)">&quot;.&quot;</span><span style="color: var(--shiki-color-text)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">	</span><span style="color: var(--shiki-token-comment); font-style: italic">// ...</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">&#125;)</span></span></code></pre>`,be,bs,it,ao,xe,Ol='<pre class="shiki   language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ go run main.go</span></span></code></pre>',we,L,pt,_e,ct,kt,to,Ee,Rl=`<pre class="shiki   language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ kubectl apply </span><span style="color: var(--shiki-color-text)">-f</span><span style="color: var(--shiki-color-text)"> config</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">samples</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">_v1_hooked.yaml</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">hooked.my.domain</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">hooked</span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">sample created</span></span></code></pre>`,qe,xs,ht,lo,Pe,jl=`<pre class="shiki   language-json"><code tabindex="0"><span class="line"><span style="color: var(--shiki-token-numeric)">2021-12-23</span><span style="color: var(--shiki-color-text)">T</span><span style="color: var(--shiki-token-numeric)">15</span><span style="color: var(--shiki-color-text)">:</span><span style="color: var(--shiki-token-numeric)">03</span><span style="color: var(--shiki-color-text)">:</span><span style="color: var(--shiki-token-numeric)">08.088</span><span style="color: var(--shiki-color-text)">+</span><span style="color: var(--shiki-token-numeric)">0100</span><span style="color: var(--shiki-color-text)">	DEBUG	controller-runtime.webhook.webhooks	received request	&#123;</span><span style="color: var(--shiki-token-parameter)">&quot;webhook&quot;</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">&quot;/mutate-my-domain-v1-hooked&quot;</span><span style="color: var(--shiki-color-text)">, </span><span style="color: var(--shiki-token-parameter)">&quot;UID&quot;</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">&quot;528ccce7-6404-499d-8959-42e620a211a4&quot;</span><span style="color: var(--shiki-color-text)">, </span><span style="color: var(--shiki-token-parameter)">&quot;kind&quot;</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">&quot;my.domain/v1, Kind=Hooked&quot;</span><span style="color: var(--shiki-color-text)">, </span><span style="color: var(--shiki-token-parameter)">&quot;resource&quot;</span><span style="color: var(--shiki-color-text)">: &#123;</span><span style="color: var(--shiki-token-parameter)">&quot;group&quot;</span><span style="color: var(--shiki-color-text)">:</span><span style="color: var(--shiki-token-string)">&quot;my.domain&quot;</span><span style="color: var(--shiki-color-text)">,</span><span style="color: var(--shiki-token-parameter)">&quot;version&quot;</span><span style="color: var(--shiki-color-text)">:</span><span style="color: var(--shiki-token-string)">&quot;v1&quot;</span><span style="color: var(--shiki-color-text)">,</span><span style="color: var(--shiki-token-parameter)">&quot;resource&quot;</span><span style="color: var(--shiki-color-text)">:</span><span style="color: var(--shiki-token-string)">&quot;hookeds&quot;</span><span style="color: var(--shiki-color-text)">&#125;&#125;</span></span>
<span class="line"><span style="color: var(--shiki-token-numeric)">2021-12-23</span><span style="color: var(--shiki-color-text)">T</span><span style="color: var(--shiki-token-numeric)">15</span><span style="color: var(--shiki-color-text)">:</span><span style="color: var(--shiki-token-numeric)">03</span><span style="color: var(--shiki-color-text)">:</span><span style="color: var(--shiki-token-numeric)">08.088</span><span style="color: var(--shiki-color-text)">+</span><span style="color: var(--shiki-token-numeric)">0100</span><span style="color: var(--shiki-color-text)">	INFO	hooked-resource	default	&#123;</span><span style="color: var(--shiki-token-parameter)">&quot;name&quot;</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">&quot;hooked-sample&quot;</span><span style="color: var(--shiki-color-text)">&#125;</span></span>
<span class="line"><span style="color: var(--shiki-token-numeric)">2021-12-23</span><span style="color: var(--shiki-color-text)">T</span><span style="color: var(--shiki-token-numeric)">15</span><span style="color: var(--shiki-color-text)">:</span><span style="color: var(--shiki-token-numeric)">03</span><span style="color: var(--shiki-color-text)">:</span><span style="color: var(--shiki-token-numeric)">08.088</span><span style="color: var(--shiki-color-text)">+</span><span style="color: var(--shiki-token-numeric)">0100</span><span style="color: var(--shiki-color-text)">	DEBUG	controller-runtime.webhook.webhooks	wrote response	&#123;</span><span style="color: var(--shiki-token-parameter)">&quot;webhook&quot;</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">&quot;/mutate-my-domain-v1-hooked&quot;</span><span style="color: var(--shiki-color-text)">, </span><span style="color: var(--shiki-token-parameter)">&quot;code&quot;</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-numeric)">200</span><span style="color: var(--shiki-color-text)">, </span><span style="color: var(--shiki-token-parameter)">&quot;reason&quot;</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">&quot;&quot;</span><span style="color: var(--shiki-color-text)">, </span><span style="color: var(--shiki-token-parameter)">&quot;UID&quot;</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">&quot;528ccce7-6404-499d-8959-42e620a211a4&quot;</span><span style="color: var(--shiki-color-text)">, </span><span style="color: var(--shiki-token-parameter)">&quot;allowed&quot;</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-constant)">true</span><span style="color: var(--shiki-color-text)">&#125;</span></span></code></pre>`,Te,ws,yt,ro,_s,vt;return{c(){w=i("p"),wo=t("Admission webhook is a powerful extension mechanism, that enables to plug in admission controllers, dynamically into the Kubernetes "),M=i("a"),_o=t("API access control"),Eo=t(", to intercept requests."),Ae=c(),A=i("p"),qo=t("The flexibility of admission webhook allows to address a large spectrum of use cases, like configuration management, governance, and security, as described in "),B=i("a"),Po=t("Why do I need admission controllers?"),To=t("."),Ce=c(),u=i("p"),G=i("span"),es=i("span"),Ao=t("1"),Co=t("Conversion webhooks also exist, to convert custom resources between versions, and for which using Telepresence applies as well."),Do=t("Two types of admission webhooks can be created, "),qs=i("em"),Io=t("mutating"),So=t(" and "),Ps=i("em"),go=t("validating"),No=t(" admission webhooks"),os=i("span"),Ho=t("1"),$o=t(`.
Declaring a mutating (resp. validating) admission webhook is as simple as creating a `),Ts=i("code"),Oo=t("MutatingWebhookConfiguration"),Ro=t(" (resp. "),As=i("code"),jo=t("ValidatingAdmissionWebhooks"),Ko=t(") resource, e.g.:"),De=c(),Cs=new y(!1),Ds=c(),m=i("p"),Uo=t("With that example, The API server makes an HTTPS POST request to the "),Is=i("code"),Lo=t("https//controller.admission.svc/mutate"),Wo=t(" URL, with a JSON-encoded "),Ss=i("code"),Mo=t("AdmissionReview"),Bo=t(" in the request body, each time a "),gs=i("em"),Go=t("write"),Vo=t(" request (POST, PUT or PATCH) to the "),V=i("a"),Fo=t("Pod endpoint"),Zo=t(" is received by the API server."),Ie=c(),d=i("p"),x=i("span"),as=i("span"),zo=t("2"),Jo=t("It can also be deployed externally and referenced with the "),Ns=i("code"),Qo=t("URL"),Xo=t(" field, in which case the host should be an IP address, or resolved via an external DNS ("),Hs=i("code"),Yo=t("kube-apiserver"),sa=t(" cannot resolve in-cluster DNS as that would be a layering violation)."),ea=t("The admission controller hosting the webhook endpoint must be accessible from within the cluster, exposed as a Service"),ts=i("span"),oa=t("2"),aa=t(`.
This is diametrically opposed to `),$s=i("em"),ta=t("standard"),la=t(" controllers, or "),F=i("a"),ra=t("operators"),na=t(", that call the API server."),Se=c(),ls=i("p"),ia=t(`That difference matters during the development cycle, as the controller, running locally, is not directly accessible from the API server.
The container image has to be built, push to a registry, and the controller deployment rolled out.`),ge=c(),b=i("p"),Z=i("span"),rs=i("span"),pa=t("3"),ca=t("Telepresence is a CNCF sandbox project, that enables to connect a local machine seamlessly to a Kubernetes cluster, via a two-way proxying mechanism."),ka=t("The following post demonstrates how to use "),z=i("a"),ha=t("Telepresence"),ns=i("span"),ya=t("3"),va=t(", to intercept requests from the API server to the admission webhook service, tunnel them to the admission controller running locally, and ultimately speed the "),J=i("a"),ua=t("inner development loop"),ma=t(" up."),Ne=c(),C=i("h2"),q=i("a"),D=bo("svg"),Os=bo("path"),da=t("Kubebuilder"),He=c(),is=i("p"),fa=t("First things first, let’s create an admission controller project."),$e=c(),I=i("p"),ba=t(`There is no unique way to implement an admission webhook.
The contract is ultimately defined by the `),Q=i("a"),xa=t("webhook REST API"),wa=t(", that can be implemented with any stack."),Oe=c(),S=i("p"),_a=t("That being said, the "),X=i("a"),Ea=t("Kubebuilder"),qa=t(` project provides tools that scafold projects, for implementing Kubernetes API and webhook.
So let’s use it to create our admission controller…`),Re=c(),g=i("p"),Pa=t("1) Install the "),Rs=i("code"),Ta=t("kubebuilder"),Aa=t(" CLI:"),je=c(),js=new y(!1),Ks=c(),ps=i("p"),Ca=t("2) Scafold the project:"),Ke=c(),Us=new y(!1),Ls=c(),N=i("p"),Da=t("3) Define the "),Ws=i("code"),Ia=t("Hooked"),Sa=t(" CRD, and the associated mutating webhook:"),Ue=c(),Ms=new y(!1),Bs=c(),H=i("p"),ga=t(`It’s also possible to define webhooks for core types.
However, Kubebuilder does not support scafolding webhook in that case.
So the generated project must be modified manually, as documented in `),Y=i("a"),Na=t("admission webhook for core types"),Ha=t("."),Le=c(),cs=i("p"),$a=t("4) Install the generated CRD manifest:"),We=c(),Gs=new y(!1),Vs=c(),ks=i("p"),Oa=t("5) Create a namespace:"),Me=c(),Fs=new y(!1),Zs=c(),hs=i("p"),Ra=t("6) Deploy the generated webhook manifests:"),Be=c(),zs=new y(!1),Js=c(),$=i("p"),ja=t("7) Create a sample "),Qs=i("code"),Ka=t("Hooked"),Ua=t(" resource:"),Ge=c(),Xs=new y(!1),Ys=c(),O=i("p"),La=t("The API server calls the service configured into the "),se=i("code"),Wa=t("MutatingWebhookConfiguration"),Ma=t(` resource.
This fails as expected, since we haven’t deployed any endpoint yet, to actually serve the request.`),Ve=c(),ys=i("p"),Ba=t(`In production, that endpoint is generally exposed by the admission controller, deployed in-cluster.
However, during the development phase, we want the requests to be processed by the admission controller, running locally.`),Fe=c(),R=i("h2"),P=i("a"),j=bo("svg"),ee=bo("path"),Ga=t("Telepresence"),Ze=c(),vs=i("p"),Va=t(`Thanks to Telepresence, it’s possible to have the requests issued by the API server tunneled to the local machine.
Let’s use it to intercept the requests received by the webhook service, deployed in the cluster, and tunnel them to the admission controller started locally.`),ze=c(),K=i("p"),Fa=t("1) Install the "),oe=i("code"),Za=t("telepresence"),za=t(" CLI:"),Je=c(),ae=new y(!1),te=c(),us=i("p"),Ja=t("2) Connect Telepresence to the cluster, and check the status:"),Qe=c(),le=new y(!1),re=c(),U=i("p"),Qa=t("3) Telepresence requires a "),ne=i("code"),Xa=t("Deployment"),Ya=t(", as interception target, so instead of relying on the real controller deployment, let’s create a compatible mock:"),Xe=c(),ie=new y(!1),pe=c(),ms=i("p"),st=t("4) Intercept the webhook service:"),Ye=c(),ce=new y(!1),ke=c(),ds=i("p"),et=t("5) Generate the webhook server certificate, as the API server mandates HTTPS:"),so=c(),he=new y(!1),ye=c(),_=i("p"),ot=t("6) Patch the "),ve=i("code"),at=t("MutatingWebhookConfiguration"),tt=t(" resource, to set the "),ue=i("code"),lt=t("caBundle"),rt=t(" field with the generated CA certificate:"),eo=c(),me=new y(!1),de=c(),fs=i("p"),nt=t("7) Update the controller manager, to source certificates from the project directory:"),oo=c(),fe=new y(!1),be=c(),bs=i("p"),it=t("8) Start the admission controller:"),ao=c(),xe=new y(!1),we=c(),L=i("p"),pt=t("9) Create a sample "),_e=i("code"),ct=t("Hooked"),kt=t(" resource:"),to=c(),Ee=new y(!1),qe=c(),xs=i("p"),ht=t("10) Check the admission controller output:"),lo=c(),Pe=new y(!1),Te=c(),ws=i("p"),yt=t("Hooray, the admission controller running locally is called!"),ro=c(),_s=i("p"),vt=t("Happy coding!"),this.h()},l(s){w=p(s,"P",{});var a=n(w);wo=l(a,"Admission webhook is a powerful extension mechanism, that enables to plug in admission controllers, dynamically into the Kubernetes "),M=p(a,"A",{href:!0,rel:!0});var xt=n(M);_o=l(xt,"API access control"),xt.forEach(e),Eo=l(a,", to intercept requests."),a.forEach(e),Ae=k(s),A=p(s,"P",{});var no=n(A);qo=l(no,"The flexibility of admission webhook allows to address a large spectrum of use cases, like configuration management, governance, and security, as described in "),B=p(no,"A",{href:!0,rel:!0});var wt=n(B);Po=l(wt,"Why do I need admission controllers?"),wt.forEach(e),To=l(no,"."),no.forEach(e),Ce=k(s),u=p(s,"P",{});var f=n(u);G=p(f,"SPAN",{class:!0});var ut=n(G);es=p(ut,"SPAN",{class:!0});var _t=n(es);Ao=l(_t,"1"),_t.forEach(e),Co=l(ut,"Conversion webhooks also exist, to convert custom resources between versions, and for which using Telepresence applies as well."),ut.forEach(e),Do=l(f,"Two types of admission webhooks can be created, "),qs=p(f,"EM",{});var Et=n(qs);Io=l(Et,"mutating"),Et.forEach(e),So=l(f," and "),Ps=p(f,"EM",{});var qt=n(Ps);go=l(qt,"validating"),qt.forEach(e),No=l(f," admission webhooks"),os=p(f,"SPAN",{class:!0});var Pt=n(os);Ho=l(Pt,"1"),Pt.forEach(e),$o=l(f,`.
Declaring a mutating (resp. validating) admission webhook is as simple as creating a `),Ts=p(f,"CODE",{});var Tt=n(Ts);Oo=l(Tt,"MutatingWebhookConfiguration"),Tt.forEach(e),Ro=l(f," (resp. "),As=p(f,"CODE",{});var At=n(As);jo=l(At,"ValidatingAdmissionWebhooks"),At.forEach(e),Ko=l(f,") resource, e.g.:"),f.forEach(e),De=k(s),Cs=v(s,!1),Ds=k(s),m=p(s,"P",{});var E=n(m);Uo=l(E,"With that example, The API server makes an HTTPS POST request to the "),Is=p(E,"CODE",{});var Ct=n(Is);Lo=l(Ct,"https//controller.admission.svc/mutate"),Ct.forEach(e),Wo=l(E," URL, with a JSON-encoded "),Ss=p(E,"CODE",{});var Dt=n(Ss);Mo=l(Dt,"AdmissionReview"),Dt.forEach(e),Bo=l(E," in the request body, each time a "),gs=p(E,"EM",{});var It=n(gs);Go=l(It,"write"),It.forEach(e),Vo=l(E," request (POST, PUT or PATCH) to the "),V=p(E,"A",{href:!0,rel:!0});var St=n(V);Fo=l(St,"Pod endpoint"),St.forEach(e),Zo=l(E," is received by the API server."),E.forEach(e),Ie=k(s),d=p(s,"P",{});var T=n(d);x=p(T,"SPAN",{class:!0});var ss=n(x);as=p(ss,"SPAN",{class:!0});var gt=n(as);zo=l(gt,"2"),gt.forEach(e),Jo=l(ss,"It can also be deployed externally and referenced with the "),Ns=p(ss,"CODE",{});var Nt=n(Ns);Qo=l(Nt,"URL"),Nt.forEach(e),Xo=l(ss," field, in which case the host should be an IP address, or resolved via an external DNS ("),Hs=p(ss,"CODE",{});var Ht=n(Hs);Yo=l(Ht,"kube-apiserver"),Ht.forEach(e),sa=l(ss," cannot resolve in-cluster DNS as that would be a layering violation)."),ss.forEach(e),ea=l(T,"The admission controller hosting the webhook endpoint must be accessible from within the cluster, exposed as a Service"),ts=p(T,"SPAN",{class:!0});var $t=n(ts);oa=l($t,"2"),$t.forEach(e),aa=l(T,`.
This is diametrically opposed to `),$s=p(T,"EM",{});var Ot=n($s);ta=l(Ot,"standard"),Ot.forEach(e),la=l(T," controllers, or "),F=p(T,"A",{href:!0,rel:!0});var Rt=n(F);ra=l(Rt,"operators"),Rt.forEach(e),na=l(T,", that call the API server."),T.forEach(e),Se=k(s),ls=p(s,"P",{});var jt=n(ls);ia=l(jt,`That difference matters during the development cycle, as the controller, running locally, is not directly accessible from the API server.
The container image has to be built, push to a registry, and the controller deployment rolled out.`),jt.forEach(e),ge=k(s),b=p(s,"P",{});var W=n(b);Z=p(W,"SPAN",{class:!0});var mt=n(Z);rs=p(mt,"SPAN",{class:!0});var Kt=n(rs);pa=l(Kt,"3"),Kt.forEach(e),ca=l(mt,"Telepresence is a CNCF sandbox project, that enables to connect a local machine seamlessly to a Kubernetes cluster, via a two-way proxying mechanism."),mt.forEach(e),ka=l(W,"The following post demonstrates how to use "),z=p(W,"A",{href:!0,rel:!0});var Ut=n(z);ha=l(Ut,"Telepresence"),Ut.forEach(e),ns=p(W,"SPAN",{class:!0});var Lt=n(ns);ya=l(Lt,"3"),Lt.forEach(e),va=l(W,", to intercept requests from the API server to the admission webhook service, tunnel them to the admission controller running locally, and ultimately speed the "),J=p(W,"A",{href:!0,rel:!0});var Wt=n(J);ua=l(Wt,"inner development loop"),Wt.forEach(e),ma=l(W," up."),W.forEach(e),Ne=k(s),C=p(s,"H2",{id:!0});var dt=n(C);q=p(dt,"A",{class:!0,"aria-hidden":!0,tabindex:!0,href:!0});var Mt=n(q);D=xo(Mt,"svg",{viewBox:!0,version:!0,"aria-hidden":!0});var Bt=n(D);Os=xo(Bt,"path",{d:!0}),n(Os).forEach(e),Bt.forEach(e),Mt.forEach(e),da=l(dt,"Kubebuilder"),dt.forEach(e),He=k(s),is=p(s,"P",{});var Gt=n(is);fa=l(Gt,"First things first, let’s create an admission controller project."),Gt.forEach(e),$e=k(s),I=p(s,"P",{});var io=n(I);ba=l(io,`There is no unique way to implement an admission webhook.
The contract is ultimately defined by the `),Q=p(io,"A",{href:!0,rel:!0});var Vt=n(Q);xa=l(Vt,"webhook REST API"),Vt.forEach(e),wa=l(io,", that can be implemented with any stack."),io.forEach(e),Oe=k(s),S=p(s,"P",{});var po=n(S);_a=l(po,"That being said, the "),X=p(po,"A",{href:!0,rel:!0});var Ft=n(X);Ea=l(Ft,"Kubebuilder"),Ft.forEach(e),qa=l(po,` project provides tools that scafold projects, for implementing Kubernetes API and webhook.
So let’s use it to create our admission controller…`),po.forEach(e),Re=k(s),g=p(s,"P",{});var co=n(g);Pa=l(co,"1) Install the "),Rs=p(co,"CODE",{});var Zt=n(Rs);Ta=l(Zt,"kubebuilder"),Zt.forEach(e),Aa=l(co," CLI:"),co.forEach(e),je=k(s),js=v(s,!1),Ks=k(s),ps=p(s,"P",{});var zt=n(ps);Ca=l(zt,"2) Scafold the project:"),zt.forEach(e),Ke=k(s),Us=v(s,!1),Ls=k(s),N=p(s,"P",{});var ko=n(N);Da=l(ko,"3) Define the "),Ws=p(ko,"CODE",{});var Jt=n(Ws);Ia=l(Jt,"Hooked"),Jt.forEach(e),Sa=l(ko," CRD, and the associated mutating webhook:"),ko.forEach(e),Ue=k(s),Ms=v(s,!1),Bs=k(s),H=p(s,"P",{});var ho=n(H);ga=l(ho,`It’s also possible to define webhooks for core types.
However, Kubebuilder does not support scafolding webhook in that case.
So the generated project must be modified manually, as documented in `),Y=p(ho,"A",{href:!0,rel:!0});var Qt=n(Y);Na=l(Qt,"admission webhook for core types"),Qt.forEach(e),Ha=l(ho,"."),ho.forEach(e),Le=k(s),cs=p(s,"P",{});var Xt=n(cs);$a=l(Xt,"4) Install the generated CRD manifest:"),Xt.forEach(e),We=k(s),Gs=v(s,!1),Vs=k(s),ks=p(s,"P",{});var Yt=n(ks);Oa=l(Yt,"5) Create a namespace:"),Yt.forEach(e),Me=k(s),Fs=v(s,!1),Zs=k(s),hs=p(s,"P",{});var sl=n(hs);Ra=l(sl,"6) Deploy the generated webhook manifests:"),sl.forEach(e),Be=k(s),zs=v(s,!1),Js=k(s),$=p(s,"P",{});var yo=n($);ja=l(yo,"7) Create a sample "),Qs=p(yo,"CODE",{});var el=n(Qs);Ka=l(el,"Hooked"),el.forEach(e),Ua=l(yo," resource:"),yo.forEach(e),Ge=k(s),Xs=v(s,!1),Ys=k(s),O=p(s,"P",{});var vo=n(O);La=l(vo,"The API server calls the service configured into the "),se=p(vo,"CODE",{});var ol=n(se);Wa=l(ol,"MutatingWebhookConfiguration"),ol.forEach(e),Ma=l(vo,` resource.
This fails as expected, since we haven’t deployed any endpoint yet, to actually serve the request.`),vo.forEach(e),Ve=k(s),ys=p(s,"P",{});var al=n(ys);Ba=l(al,`In production, that endpoint is generally exposed by the admission controller, deployed in-cluster.
However, during the development phase, we want the requests to be processed by the admission controller, running locally.`),al.forEach(e),Fe=k(s),R=p(s,"H2",{id:!0});var ft=n(R);P=p(ft,"A",{class:!0,"aria-hidden":!0,tabindex:!0,href:!0});var tl=n(P);j=xo(tl,"svg",{viewBox:!0,version:!0,"aria-hidden":!0});var ll=n(j);ee=xo(ll,"path",{d:!0}),n(ee).forEach(e),ll.forEach(e),tl.forEach(e),Ga=l(ft,"Telepresence"),ft.forEach(e),Ze=k(s),vs=p(s,"P",{});var rl=n(vs);Va=l(rl,`Thanks to Telepresence, it’s possible to have the requests issued by the API server tunneled to the local machine.
Let’s use it to intercept the requests received by the webhook service, deployed in the cluster, and tunnel them to the admission controller started locally.`),rl.forEach(e),ze=k(s),K=p(s,"P",{});var uo=n(K);Fa=l(uo,"1) Install the "),oe=p(uo,"CODE",{});var nl=n(oe);Za=l(nl,"telepresence"),nl.forEach(e),za=l(uo," CLI:"),uo.forEach(e),Je=k(s),ae=v(s,!1),te=k(s),us=p(s,"P",{});var il=n(us);Ja=l(il,"2) Connect Telepresence to the cluster, and check the status:"),il.forEach(e),Qe=k(s),le=v(s,!1),re=k(s),U=p(s,"P",{});var mo=n(U);Qa=l(mo,"3) Telepresence requires a "),ne=p(mo,"CODE",{});var pl=n(ne);Xa=l(pl,"Deployment"),pl.forEach(e),Ya=l(mo,", as interception target, so instead of relying on the real controller deployment, let’s create a compatible mock:"),mo.forEach(e),Xe=k(s),ie=v(s,!1),pe=k(s),ms=p(s,"P",{});var cl=n(ms);st=l(cl,"4) Intercept the webhook service:"),cl.forEach(e),Ye=k(s),ce=v(s,!1),ke=k(s),ds=p(s,"P",{});var kl=n(ds);et=l(kl,"5) Generate the webhook server certificate, as the API server mandates HTTPS:"),kl.forEach(e),so=k(s),he=v(s,!1),ye=k(s),_=p(s,"P",{});var Es=n(_);ot=l(Es,"6) Patch the "),ve=p(Es,"CODE",{});var hl=n(ve);at=l(hl,"MutatingWebhookConfiguration"),hl.forEach(e),tt=l(Es," resource, to set the "),ue=p(Es,"CODE",{});var yl=n(ue);lt=l(yl,"caBundle"),yl.forEach(e),rt=l(Es," field with the generated CA certificate:"),Es.forEach(e),eo=k(s),me=v(s,!1),de=k(s),fs=p(s,"P",{});var vl=n(fs);nt=l(vl,"7) Update the controller manager, to source certificates from the project directory:"),vl.forEach(e),oo=k(s),fe=v(s,!1),be=k(s),bs=p(s,"P",{});var ul=n(bs);it=l(ul,"8) Start the admission controller:"),ul.forEach(e),ao=k(s),xe=v(s,!1),we=k(s),L=p(s,"P",{});var fo=n(L);pt=l(fo,"9) Create a sample "),_e=p(fo,"CODE",{});var ml=n(_e);ct=l(ml,"Hooked"),ml.forEach(e),kt=l(fo," resource:"),fo.forEach(e),to=k(s),Ee=v(s,!1),qe=k(s),xs=p(s,"P",{});var dl=n(xs);ht=l(dl,"10) Check the admission controller output:"),dl.forEach(e),lo=k(s),Pe=v(s,!1),Te=k(s),ws=p(s,"P",{});var fl=n(ws);yt=l(fl,"Hooray, the admission controller running locally is called!"),fl.forEach(e),ro=k(s),_s=p(s,"P",{});var bl=n(_s);vt=l(bl,"Happy coding!"),bl.forEach(e),this.h()},h(){h(M,"href","https://kubernetes.io/docs/concepts/security/controlling-access/#admission-control"),h(M,"rel","nofollow"),h(B,"href","https://kubernetes.io/blog/2019/03/21/a-guide-to-kubernetes-admission-controllers/#why-do-i-need-admission-controllers"),h(B,"rel","nofollow"),h(es,"class","sidenote-number"),h(G,"class","note sidenote"),h(os,"class","sidenote-number"),Cs.a=Ds,h(V,"href","https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.22/#pod-v1-core"),h(V,"rel","nofollow"),h(as,"class","sidenote-number"),h(x,"class","note sidenote"),h(ts,"class","sidenote-number"),h(F,"href","https://operatorframework.io"),h(F,"rel","nofollow"),h(rs,"class","sidenote-number"),h(Z,"class","note sidenote"),h(z,"href","https://www.telepresence.io"),h(z,"rel","nofollow"),h(ns,"class","sidenote-number"),h(J,"href","https://www.telepresence.io/docs/v2.4/concepts/devloop/"),h(J,"rel","nofollow"),h(Os,"d","m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"),h(D,"viewBox","0 0 16 16"),h(D,"version","1.1"),h(D,"aria-hidden","true"),h(q,"class","anchor"),h(q,"aria-hidden","true"),h(q,"tabindex","-1"),h(q,"href","#kubebuilder"),h(C,"id","kubebuilder"),h(Q,"href","https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#webhook-request-and-response"),h(Q,"rel","nofollow"),h(X,"href","https://github.com/kubernetes-sigs/kubebuilder"),h(X,"rel","nofollow"),js.a=Ks,Us.a=Ls,Ms.a=Bs,h(Y,"href","https://book.kubebuilder.io/reference/webhook-for-core-types.html"),h(Y,"rel","nofollow"),Gs.a=Vs,Fs.a=Zs,zs.a=Js,Xs.a=Ys,h(ee,"d","m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"),h(j,"viewBox","0 0 16 16"),h(j,"version","1.1"),h(j,"aria-hidden","true"),h(P,"class","anchor"),h(P,"aria-hidden","true"),h(P,"tabindex","-1"),h(P,"href","#telepresence"),h(R,"id","telepresence"),ae.a=te,le.a=re,ie.a=pe,ce.a=ke,he.a=ye,me.a=de,fe.a=be,xe.a=we,Ee.a=qe,Pe.a=Te},m(s,a){r(s,w,a),o(w,wo),o(w,M),o(M,_o),o(w,Eo),r(s,Ae,a),r(s,A,a),o(A,qo),o(A,B),o(B,Po),o(A,To),r(s,Ce,a),r(s,u,a),o(u,G),o(G,es),o(es,Ao),o(G,Co),o(u,Do),o(u,qs),o(qs,Io),o(u,So),o(u,Ps),o(Ps,go),o(u,No),o(u,os),o(os,Ho),o(u,$o),o(u,Ts),o(Ts,Oo),o(u,Ro),o(u,As),o(As,jo),o(u,Ko),r(s,De,a),Cs.m(wl,s,a),r(s,Ds,a),r(s,m,a),o(m,Uo),o(m,Is),o(Is,Lo),o(m,Wo),o(m,Ss),o(Ss,Mo),o(m,Bo),o(m,gs),o(gs,Go),o(m,Vo),o(m,V),o(V,Fo),o(m,Zo),r(s,Ie,a),r(s,d,a),o(d,x),o(x,as),o(as,zo),o(x,Jo),o(x,Ns),o(Ns,Qo),o(x,Xo),o(x,Hs),o(Hs,Yo),o(x,sa),o(d,ea),o(d,ts),o(ts,oa),o(d,aa),o(d,$s),o($s,ta),o(d,la),o(d,F),o(F,ra),o(d,na),r(s,Se,a),r(s,ls,a),o(ls,ia),r(s,ge,a),r(s,b,a),o(b,Z),o(Z,rs),o(rs,pa),o(Z,ca),o(b,ka),o(b,z),o(z,ha),o(b,ns),o(ns,ya),o(b,va),o(b,J),o(J,ua),o(b,ma),r(s,Ne,a),r(s,C,a),o(C,q),o(q,D),o(D,Os),o(C,da),r(s,He,a),r(s,is,a),o(is,fa),r(s,$e,a),r(s,I,a),o(I,ba),o(I,Q),o(Q,xa),o(I,wa),r(s,Oe,a),r(s,S,a),o(S,_a),o(S,X),o(X,Ea),o(S,qa),r(s,Re,a),r(s,g,a),o(g,Pa),o(g,Rs),o(Rs,Ta),o(g,Aa),r(s,je,a),js.m(_l,s,a),r(s,Ks,a),r(s,ps,a),o(ps,Ca),r(s,Ke,a),Us.m(El,s,a),r(s,Ls,a),r(s,N,a),o(N,Da),o(N,Ws),o(Ws,Ia),o(N,Sa),r(s,Ue,a),Ms.m(ql,s,a),r(s,Bs,a),r(s,H,a),o(H,ga),o(H,Y),o(Y,Na),o(H,Ha),r(s,Le,a),r(s,cs,a),o(cs,$a),r(s,We,a),Gs.m(Pl,s,a),r(s,Vs,a),r(s,ks,a),o(ks,Oa),r(s,Me,a),Fs.m(Tl,s,a),r(s,Zs,a),r(s,hs,a),o(hs,Ra),r(s,Be,a),zs.m(Al,s,a),r(s,Js,a),r(s,$,a),o($,ja),o($,Qs),o(Qs,Ka),o($,Ua),r(s,Ge,a),Xs.m(Cl,s,a),r(s,Ys,a),r(s,O,a),o(O,La),o(O,se),o(se,Wa),o(O,Ma),r(s,Ve,a),r(s,ys,a),o(ys,Ba),r(s,Fe,a),r(s,R,a),o(R,P),o(P,j),o(j,ee),o(R,Ga),r(s,Ze,a),r(s,vs,a),o(vs,Va),r(s,ze,a),r(s,K,a),o(K,Fa),o(K,oe),o(oe,Za),o(K,za),r(s,Je,a),ae.m(Dl,s,a),r(s,te,a),r(s,us,a),o(us,Ja),r(s,Qe,a),le.m(Il,s,a),r(s,re,a),r(s,U,a),o(U,Qa),o(U,ne),o(ne,Xa),o(U,Ya),r(s,Xe,a),ie.m(Sl,s,a),r(s,pe,a),r(s,ms,a),o(ms,st),r(s,Ye,a),ce.m(gl,s,a),r(s,ke,a),r(s,ds,a),o(ds,et),r(s,so,a),he.m(Nl,s,a),r(s,ye,a),r(s,_,a),o(_,ot),o(_,ve),o(ve,at),o(_,tt),o(_,ue),o(ue,lt),o(_,rt),r(s,eo,a),me.m(Hl,s,a),r(s,de,a),r(s,fs,a),o(fs,nt),r(s,oo,a),fe.m($l,s,a),r(s,be,a),r(s,bs,a),o(bs,it),r(s,ao,a),xe.m(Ol,s,a),r(s,we,a),r(s,L,a),o(L,pt),o(L,_e),o(_e,ct),o(L,kt),r(s,to,a),Ee.m(Rl,s,a),r(s,qe,a),r(s,xs,a),o(xs,ht),r(s,lo,a),Pe.m(jl,s,a),r(s,Te,a),r(s,ws,a),o(ws,yt),r(s,ro,a),r(s,_s,a),o(_s,vt)},p:bt,i:bt,o:bt,d(s){s&&e(w),s&&e(Ae),s&&e(A),s&&e(Ce),s&&e(u),s&&e(De),s&&Cs.d(),s&&e(Ds),s&&e(m),s&&e(Ie),s&&e(d),s&&e(Se),s&&e(ls),s&&e(ge),s&&e(b),s&&e(Ne),s&&e(C),s&&e(He),s&&e(is),s&&e($e),s&&e(I),s&&e(Oe),s&&e(S),s&&e(Re),s&&e(g),s&&e(je),s&&js.d(),s&&e(Ks),s&&e(ps),s&&e(Ke),s&&Us.d(),s&&e(Ls),s&&e(N),s&&e(Ue),s&&Ms.d(),s&&e(Bs),s&&e(H),s&&e(Le),s&&e(cs),s&&e(We),s&&Gs.d(),s&&e(Vs),s&&e(ks),s&&e(Me),s&&Fs.d(),s&&e(Zs),s&&e(hs),s&&e(Be),s&&zs.d(),s&&e(Js),s&&e($),s&&e(Ge),s&&Xs.d(),s&&e(Ys),s&&e(O),s&&e(Ve),s&&e(ys),s&&e(Fe),s&&e(R),s&&e(Ze),s&&e(vs),s&&e(ze),s&&e(K),s&&e(Je),s&&ae.d(),s&&e(te),s&&e(us),s&&e(Qe),s&&le.d(),s&&e(re),s&&e(U),s&&e(Xe),s&&ie.d(),s&&e(pe),s&&e(ms),s&&e(Ye),s&&ce.d(),s&&e(ke),s&&e(ds),s&&e(so),s&&he.d(),s&&e(ye),s&&e(_),s&&e(eo),s&&me.d(),s&&e(de),s&&e(fs),s&&e(oo),s&&fe.d(),s&&e(be),s&&e(bs),s&&e(ao),s&&xe.d(),s&&e(we),s&&e(L),s&&e(to),s&&Ee.d(),s&&e(qe),s&&e(xs),s&&e(lo),s&&Pe.d(),s&&e(Te),s&&e(ws),s&&e(ro),s&&e(_s)}}}const Bl={title:"Developing a Kubernetes Admission Controller with Telepresence",date:"2021-12-21T00:00:00.000Z",published:!0,slug:"kubernetes-admission-controller",tags:["Kubernetes"]};class Gl extends Kl{constructor(w){super(),Ul(this,w,null,Wl,Ll,{})}}export{Gl as default,Bl as metadata};
