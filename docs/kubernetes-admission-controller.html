<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <link rel="icon" href="./favicon-32x32.png" type="image/png" />
  <link rel="icon" href="./favicon.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="./katex.min.css" />
  <meta name="viewport" content="width=device-width" />
  <meta http-equiv="content-security-policy" content="">
		<link href="./_app/immutable/assets/_layout.30fd11a6.css" rel="stylesheet">
		<link href="./_app/immutable/assets/ArticleMeta.e75ae3db.css" rel="stylesheet">
		<link href="./_app/immutable/assets/Image.b943bec2.css" rel="stylesheet">
		<link rel="modulepreload" href="./_app/immutable/entry/start.00b47e61.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/index.39ce08e8.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/singletons.b8834bb0.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/index.20663a5b.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/control.e7f5239e.js">
		<link rel="modulepreload" href="./_app/immutable/entry/app.22c486c8.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/preload-helper.41c905a7.js">
		<link rel="modulepreload" href="./_app/immutable/entry/_layout.svelte.0235d516.js">
		<link rel="modulepreload" href="./_app/immutable/entry/_layout.ts.984db11e.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/_layout.da46b06b.js">
		<link rel="modulepreload" href="./_app/immutable/entry/_slug_-page.svelte.640de55a.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/ArticleMeta.8e357784.js">
		<link rel="modulepreload" href="./_app/immutable/entry/_slug_-page.ts.a9608ae8.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/_page.9b02f357.js"><title>Developing a Kubernetes Admission Controller with Telepresence</title><!-- HEAD_svelte-1lbq8gn_START --><!-- HTML_TAG_START --><script>!function(){try {var d=document.documentElement;var e=localStorage.getItem('theme');if("system"===e||(!e&&true)){var t="(prefers-color-scheme: dark)",m=window.matchMedia(t);if(m.media!==t||m.matches){d.setAttribute('data-theme', 'dark');document.documentElement.style.setProperty('color-scheme', 'dark')}else{d.setAttribute('data-theme', 'light');document.documentElement.style.setProperty('color-scheme', 'light')}}else if(e){ d.setAttribute('data-theme', e);document.documentElement.style.setProperty('color-scheme', e)}}catch(e){}}()</script><!-- HTML_TAG_END --><!-- HEAD_svelte-1lbq8gn_END --><!-- HEAD_svelte-1uq71di_START --><meta property="og:site_name" content="ttt.io"><meta property="og:title" content="Developing a Kubernetes Admission Controller with Telepresence"><meta property="og:description"><!-- HEAD_svelte-1uq71di_END -->
</head>

<body data-sveltekit-preload-data="hover">
  <div style="display: contents">






<header class="navbar"><span><a href="/"><span class="title small">ttt.io</span></a>
    <span class="icons"><a class="icon" href="https://github.com/astefanutti"><!-- HTML_TAG_START --><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg><!-- HTML_TAG_END --></a>
      <a class="icon" href="https://fosstodon.org/@ttt"><!-- HTML_TAG_START --><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Mastodon</title><path d="M23.268 5.313c-.35-2.578-2.617-4.61-5.304-5.004C17.51.242 15.792 0 11.813 0h-.03c-3.98 0-4.835.242-5.288.309C3.882.692 1.496 2.518.917 5.127.64 6.412.61 7.837.661 9.143c.074 1.874.088 3.745.26 5.611.118 1.24.325 2.47.62 3.68.55 2.237 2.777 4.098 4.96 4.857 2.336.792 4.849.923 7.256.38.265-.061.527-.132.786-.213.585-.184 1.27-.39 1.774-.753a.057.057 0 0 0 .023-.043v-1.809a.052.052 0 0 0-.02-.041.053.053 0 0 0-.046-.01 20.282 20.282 0 0 1-4.709.545c-2.73 0-3.463-1.284-3.674-1.818a5.593 5.593 0 0 1-.319-1.433.053.053 0 0 1 .066-.054c1.517.363 3.072.546 4.632.546.376 0 .75 0 1.125-.01 1.57-.044 3.224-.124 4.768-.422.038-.008.077-.015.11-.024 2.435-.464 4.753-1.92 4.989-5.604.008-.145.03-1.52.03-1.67.002-.512.167-3.63-.024-5.545zm-3.748 9.195h-2.561V8.29c0-1.309-.55-1.976-1.67-1.976-1.23 0-1.846.79-1.846 2.35v3.403h-2.546V8.663c0-1.56-.617-2.35-1.848-2.35-1.112 0-1.668.668-1.67 1.977v6.218H4.822V8.102c0-1.31.337-2.35 1.011-3.12.696-.77 1.608-1.164 2.74-1.164 1.311 0 2.302.5 2.962 1.498l.638 1.06.638-1.06c.66-.999 1.65-1.498 2.96-1.498 1.13 0 2.043.395 2.74 1.164.675.77 1.012 1.81 1.012 3.12z"/></svg><!-- HTML_TAG_END --></a>
      <a class="icon" href="https://twitter.com/a7tti"><!-- HTML_TAG_START --><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Twitter</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg><!-- HTML_TAG_END --></a></span></span>

  <fieldset class="toggle-group svelte-1o5f7om"><label class="svelte-1o5f7om"><input type="radio" name="color-scheme" id="color-scheme-light" value="light"  data-sr class="svelte-1o5f7om">
      <!-- HTML_TAG_START --><svg role="img" viewBox="0 0 24 24" aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg">
      <path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"/>
      <path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"/>
      <path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"/>
      <path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"/>
      <path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"/>
      <path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"/>
      <path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"/>
      <path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"/>
      <path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"/>
    </svg><!-- HTML_TAG_END --></label>
    <label class="svelte-1o5f7om"><input type="radio" name="color-scheme" value="system"  data-sr class="svelte-1o5f7om">
      <!-- HTML_TAG_START --><svg role="img" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg">
      <path d="M27,14h-0.172c-0.478,0-0.904-0.337-0.98-0.809c-0.037-0.229-0.081-0.456-0.132-0.68c-0.106-0.464,0.158-0.933,0.597-1.115l0.156-0.065c0.51-0.211,0.753-0.796,0.541-1.307v0c-0.211-0.51-0.796-0.753-1.307-0.541l-0.16,0.066c-0.441,0.183-0.961,0.035-1.214-0.37c-0.122-0.196-0.25-0.388-0.384-0.576c-0.277-0.388-0.213-0.924,0.124-1.261l0.122-0.122c0.391-0.391,0.391-1.024,0-1.414l0,0c-0.391-0.391-1.024-0.391-1.414,0L22.656,5.93c-0.337,0.337-0.873,0.401-1.261,0.124c-0.188-0.134-0.38-0.262-0.576-0.384c-0.405-0.252-0.553-0.773-0.37-1.214l0.066-0.16c0.211-0.51-0.031-1.095-0.541-1.307c-0.51-0.211-1.095,0.031-1.307,0.541l-0.065,0.156c-0.182,0.439-0.651,0.703-1.115,0.597c-0.224-0.051-0.451-0.095-0.68-0.132C16.337,4.076,16,3.65,16,3.172V3c0-0.552-0.448-1-1-1s-1,0.448-1,1v0.172c0,0.478-0.337,0.904-0.809,0.98c-0.229,0.037-0.456,0.081-0.68,0.132c-0.464,0.106-0.933-0.158-1.115-0.597l-0.065-0.156c-0.211-0.51-0.796-0.753-1.307-0.541c-0.51,0.211-0.753,0.796-0.541,1.307l0.066,0.16C9.733,4.897,9.586,5.418,9.18,5.67C8.984,5.792,8.792,5.92,8.605,6.053C8.217,6.33,7.681,6.267,7.344,5.93L7.222,5.808c-0.391-0.391-1.024-0.391-1.414,0l0,0c-0.39,0.391-0.39,1.024,0,1.414L5.93,7.344C6.267,7.681,6.33,8.216,6.053,8.605C5.92,8.792,5.792,8.984,5.67,9.18C5.418,9.586,4.897,9.733,4.456,9.55l-0.16-0.066c-0.51-0.211-1.095,0.031-1.307,0.541v0c-0.211,0.51,0.031,1.095,0.541,1.307l0.156,0.065c0.439,0.182,0.703,0.651,0.597,1.115c-0.051,0.224-0.095,0.451-0.132,0.68C4.076,13.663,3.65,14,3.172,14H3c-0.552,0-1,0.448-1,1v0c0,0.552,0.448,1,1,1h0.172c0.478,0,0.904,0.337,0.98,0.809c0.037,0.229,0.081,0.456,0.132,0.68c0.106,0.464-0.158,0.933-0.597,1.115l-0.156,0.065c-0.51,0.211-0.753,0.796-0.541,1.307v0c0.211,0.51,0.796,0.753,1.307,0.541l0.16-0.066c0.441-0.183,0.961-0.035,1.214,0.37c0.122,0.196,0.25,0.388,0.384,0.576c0.277,0.388,0.213,0.924-0.124,1.261l-0.122,0.122c-0.391,0.391-0.391,1.024,0,1.414s1.024,0.391,1.414,0l0.122-0.122c0.337-0.337,0.873-0.401,1.261-0.124c0.188,0.134,0.38,0.262,0.576,0.384c0.405,0.252,0.553,0.773,0.37,1.214l-0.066,0.16c-0.211,0.51,0.031,1.095,0.541,1.307c0.51,0.211,1.095-0.031,1.307-0.541l0.065-0.156c0.182-0.439,0.651-0.703,1.115-0.597c0.224,0.051,0.451,0.095,0.68,0.132C13.663,25.924,14,26.35,14,26.828V27c0,0.552,0.448,1,1,1s1-0.448,1-1v-0.172c0-0.478,0.337-0.904,0.809-0.98c0.229-0.037,0.456-0.081,0.68-0.132c0.464-0.106,0.933,0.158,1.115,0.597l0.065,0.156c0.211,0.51,0.796,0.753,1.307,0.541c0.51-0.211,0.753-0.796,0.541-1.307l-0.066-0.16c-0.183-0.441-0.035-0.961,0.37-1.214c0.196-0.122,0.388-0.25,0.576-0.384c0.388-0.277,0.924-0.213,1.261,0.124l0.122,0.122c0.391,0.391,1.024,0.391,1.414,0s0.391-1.024,0-1.414l-0.122-0.122c-0.337-0.337-0.401-0.873-0.124-1.261c0.134-0.188,0.262-0.38,0.384-0.576c0.252-0.405,0.773-0.553,1.214-0.37l0.16,0.066c0.51,0.211,1.095-0.031,1.307-0.541v0c0.211-0.51-0.031-1.095-0.541-1.307l-0.156-0.065c-0.439-0.182-0.703-0.651-0.597-1.115c0.051-0.224,0.095-0.451,0.132-0.68C25.924,16.337,26.35,16,26.828,16H27c0.552,0,1-0.448,1-1v0C28,14.448,27.552,14,27,14z M15,23c-4.418,0-8-3.582-8-8s3.582-8,8-8s8,3.582,8,8S19.418,23,15,23z"/>
      < rect x="15" y="14" width="9" height="2"/>
      <rect x="8.25" y="10.103" transform="matrix(0.5 0.866 -0.866 0.5 15.9904 -5.4904)" width="9" height="2"/>
      <rect x="8.125" y="17.681" transform="matrix(-0.5 0.866 -0.866 -0.5 35.4904 16.8708)" width="9.5" height="2"/>
      <circle cx="15" cy="15" r="2"/>
    </svg><!-- HTML_TAG_END --></label>
    <label class="svelte-1o5f7om"><input type="radio" name="color-scheme" id="color-scheme-dark" value="dark"  data-sr class="svelte-1o5f7om">
      <!-- HTML_TAG_START --><svg role="img" viewBox="0 0 24 24" aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg">
      <path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"/>
    </svg><!-- HTML_TAG_END --></label></fieldset></header>

<main>
<h1 class="heading svelte-171h6gf large">Developing a Kubernetes Admission Controller with Telepresence</h1>
<p class="svelte-4ufgo2">
  <span class="date svelte-4ufgo2">Tue Dec 21 2021</span>
</p>

<p>Admission webhook is a powerful extension mechanism, that enables to plug in admission controllers, dynamically into the Kubernetes <a href="https://kubernetes.io/docs/concepts/security/controlling-access/#admission-control" rel="nofollow">API access control</a>, to intercept requests.</p>
<p>The flexibility of admission webhook allows to address a large spectrum of use cases, like configuration management, governance, and security, as described in <a href="https://kubernetes.io/blog/2019/03/21/a-guide-to-kubernetes-admission-controllers/#why-do-i-need-admission-controllers" rel="nofollow">Why do I need admission controllers?</a>.</p>
<p>Two types of admission webhooks can be created, <em>mutating</em> and <em>validating</em> admission webhooks<span class="sidenote-number"></span><span class="sidenote">Conversion webhooks also exist, to convert custom resources between versions, and for which using Telepresence applies as well.</span>.
Declaring a mutating (resp. validating) admission webhook is as simple as creating a <code>MutatingWebhookConfiguration</code> (resp. <code>ValidatingAdmissionWebhooks</code>) resource, e.g.:</p>
<pre class="shiki language-yaml"><code tabindex="0"><span class="line"><span style="color: var(--shiki-token-parameter)">apiVersion</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">admissionregistration.k8s.io/v1</span></span>
<span class="line"><span style="color: var(--shiki-token-parameter)">kind</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">MutatingWebhookConfiguration</span></span>
<span class="line"><span style="color: var(--shiki-token-parameter)">metadata</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-parameter)">name</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">webhook</span></span>
<span class="line"><span style="color: var(--shiki-token-parameter)">webhooks</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  - </span><span style="color: var(--shiki-token-parameter)">name</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">webhook</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-parameter)">clientConfig</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-parameter)">service</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-parameter)">name</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">controller</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-parameter)">namespace</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">admission</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-parameter)">path</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">/mutate</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-parameter)">rules</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      - </span><span style="color: var(--shiki-token-parameter)">apiGroups</span><span style="color: var(--shiki-color-text)">: [</span><span style="color: var(--shiki-token-string)">&quot;&quot;</span><span style="color: var(--shiki-color-text)">]</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-parameter)">apiVersions</span><span style="color: var(--shiki-color-text)">: [</span><span style="color: var(--shiki-token-string)">&quot;v1&quot;</span><span style="color: var(--shiki-color-text)">]</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-parameter)">resources</span><span style="color: var(--shiki-color-text)">: [</span><span style="color: var(--shiki-token-string)">&quot;pods&quot;</span><span style="color: var(--shiki-color-text)">]</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-parameter)">operations</span><span style="color: var(--shiki-color-text)">: [</span><span style="color: var(--shiki-token-string)">&quot;CREATE&quot;</span><span style="color: var(--shiki-color-text)">, </span><span style="color: var(--shiki-token-string)">&quot;UPDATE&quot;</span><span style="color: var(--shiki-color-text)">]</span></span></code></pre>
<p>With that example, The API server makes an HTTPS POST request to the <code>https//controller.admission.svc/mutate</code> URL, with a JSON-encoded <code>AdmissionReview</code> in the request body, each time a <em>write</em> request (POST, PUT or PATCH) to the <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.22/#pod-v1-core" rel="nofollow">Pod endpoint</a> is received by the API server.</p>
<p>The admission controller hosting the webhook endpoint must be accessible from within the cluster, exposed as a Service<span class="sidenote-number"></span><span class="sidenote">It can also be deployed externally and referenced with the <code>URL</code> field, in which case the host should be an IP address, or resolved via an external DNS (<code>kube-apiserver</code> cannot resolve in-cluster DNS as that would be a layering violation).</span>.
This is diametrically opposed to <em>standard</em> controllers, or <a href="https://operatorframework.io" rel="nofollow">operators</a>, that call the API server.</p>
<p>That difference matters during the development cycle, as the controller, running locally, is not directly accessible from the API server.
The container image has to be built, push to a registry, and the controller deployment rolled out.</p>
<p>The following post demonstrates how to use <a href="https://www.telepresence.io" rel="nofollow">Telepresence</a><span class="sidenote-number"></span><span class="sidenote">Telepresence is a CNCF sandbox project, that enables to connect a local machine seamlessly to a Kubernetes cluster, via a two-way proxying mechanism.</span>, to intercept requests from the API server to the admission webhook service, tunnel them to the admission controller running locally, and ultimately speed the <a href="https://www.telepresence.io/docs/v2.4/concepts/devloop/" rel="nofollow">inner development loop</a> up.</p>
<h2 id="kubebuilder"><a class="anchor" aria-hidden="true" tabindex="-1" href="#kubebuilder"><svg viewBox="0 0 16 16" version="1.1" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Kubebuilder</h2>
<p>First things first, let’s create an admission controller project.</p>
<p>There is no unique way to implement an admission webhook.
The contract is ultimately defined by the <a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#webhook-request-and-response" rel="nofollow">webhook REST API</a>, that can be implemented with any stack.</p>
<p>That being said, the <a href="https://github.com/kubernetes-sigs/kubebuilder" rel="nofollow">Kubebuilder</a> project provides tools that scafold projects, for implementing Kubernetes API and webhook.
So let’s use it to create our admission controller…</p>
<p>1) Install the <code>kubebuilder</code> CLI:</p>
<pre class="shiki language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ curl </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">L </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">o kubebuilder https:</span><span style="color: var(--shiki-token-symbol)">//</span><span style="color: var(--shiki-color-text)">go.kubebuilder.io</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">dl</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-token-numeric)">3.2</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-numeric)">0</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-token-keyword)">$</span><span style="color: var(--shiki-color-text)">(go env GOOS)</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-token-keyword)">$</span><span style="color: var(--shiki-color-text)">(go env GOARCH)</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">$ chmod </span><span style="color: var(--shiki-token-symbol)">+</span><span style="color: var(--shiki-color-text)">x kubebuilder &amp;&amp; mv kubebuilder </span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">usr</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">local</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">bin</span><span style="color: var(--shiki-token-symbol)">/</span></span></code></pre>
<p>2) Scafold the project:</p>
<pre class="shiki language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ mkdir webhook &amp;&amp; cd webhook</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">$ kubebuilder init </span><span style="color: var(--shiki-token-symbol)">--</span><span style="color: var(--shiki-color-text)">repo </span><span style="color: var(--shiki-token-symbol)">github.com/</span><span style="color: var(--shiki-color-text)">user</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">webhook</span></span></code></pre>
<p>3) Define the <code>Hooked</code> CRD, and the associated mutating webhook:</p>
<pre class="shiki language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ kubebuilder create api </span><span style="color: var(--shiki-token-symbol)">--</span><span style="color: var(--shiki-color-text)">version v1 </span><span style="color: var(--shiki-token-symbol)">--</span><span style="color: var(--shiki-color-text)">kind Hooked</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">$ kubebuilder create webhook </span><span style="color: var(--shiki-token-symbol)">--</span><span style="color: var(--shiki-color-text)">version v1 </span><span style="color: var(--shiki-token-symbol)">--</span><span style="color: var(--shiki-color-text)">kind Hooked </span><span style="color: var(--shiki-token-symbol)">--</span><span style="color: var(--shiki-color-text)">defaulting</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">$ make manifests</span></span></code></pre>
<p>It’s also possible to define webhooks for core types.
However, Kubebuilder does not support scafolding webhook in that case.
So the generated project must be modified manually, as documented in <a href="https://book.kubebuilder.io/reference/webhook-for-core-types.html" rel="nofollow">admission webhook for core types</a>.</p>
<p>4) Install the generated CRD manifest:</p>
<pre class="shiki language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ kubectl apply </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">k config</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">crd</span></span></code></pre>
<p>5) Create a namespace:</p>
<pre class="shiki language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ kubectl create ns webhook</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">$ kubectl config </span><span style="color: var(--shiki-token-symbol)">set-context</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-symbol)">--</span><span style="color: var(--shiki-color-text)">current </span><span style="color: var(--shiki-token-symbol)">--</span><span style="color: var(--shiki-color-text)">namespace</span><span style="color: var(--shiki-token-symbol)">=</span><span style="color: var(--shiki-color-text)">webhook</span></span></code></pre>
<p>6) Deploy the generated webhook manifests:</p>
<pre class="shiki language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ </span><span style="color: var(--shiki-token-keyword)">$</span><span style="color: var(--shiki-color-text)">(cd config</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">webhook &amp;&amp; kustomize edit set namespace webhook)</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">$ kubectl apply </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">k config</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">webhook</span></span></code></pre>
<p>7) Create a sample <code>Hooked</code> resource:</p>
<pre class="shiki language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ kubectl apply </span><span style="color: var(--shiki-color-text)">-f</span><span style="color: var(--shiki-color-text)"> config</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">samples</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">_v1_hooked.yaml</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  Error </span><span style="color: var(--shiki-token-keyword)">from</span><span style="color: var(--shiki-color-text)"> server (InternalError): error when creating </span><span style="color: var(--shiki-token-string)">&quot;config/samples/_v1_hooked.yaml&quot;</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  Internal error occurred: failed calling webhook </span><span style="color: var(--shiki-token-string)">&quot;mhooked.kb.io&quot;</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    Post </span><span style="color: var(--shiki-token-string)">&quot;https://webhook-service.webhook.svc:443/mutate-my-domain-v1-hooked?timeout=10s&quot;</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      no endpoints available </span><span style="color: var(--shiki-token-keyword)">for</span><span style="color: var(--shiki-color-text)"> service </span><span style="color: var(--shiki-token-string)">&quot;webhook-service&quot;</span></span></code></pre>
<p>The API server calls the service configured into the <code>MutatingWebhookConfiguration</code> resource.
This fails as expected, since we haven’t deployed any endpoint yet, to actually serve the request.</p>
<p>In production, that endpoint is generally exposed by the admission controller, deployed in-cluster.
However, during the development phase, we want the requests to be processed by the admission controller, running locally.</p>
<h2 id="telepresence"><a class="anchor" aria-hidden="true" tabindex="-1" href="#telepresence"><svg viewBox="0 0 16 16" version="1.1" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Telepresence</h2>
<p>Thanks to Telepresence, it’s possible to have the requests issued by the API server tunneled to the local machine.
Let’s use it to intercept the requests received by the webhook service, deployed in the cluster, and tunnel them to the admission controller started locally.</p>
<p>1) Install the <code>telepresence</code> CLI:</p>
<pre class="shiki language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ curl </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">fL https:</span><span style="color: var(--shiki-token-symbol)">//</span><span style="color: var(--shiki-color-text)">app.getambassador.io</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">download</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">tel2</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">darwin</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">amd64</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-token-numeric)">2.4</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-numeric)">9</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">telepresence </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">o </span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">usr</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">local</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">bin</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">telepresence</span></span></code></pre>
<p>2) Connect Telepresence to the cluster, and check the status:</p>
<pre class="shiki language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ telepresence connect</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">Launching Telepresence Root Daemon</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">Launching Telepresence User Daemon</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">$ telepresence status</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">Root Daemon: Running</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  Version   : v2.</span><span style="color: var(--shiki-token-numeric)">4.9</span><span style="color: var(--shiki-color-text)"> (api </span><span style="color: var(--shiki-token-numeric)">3</span><span style="color: var(--shiki-color-text)">)</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  DNS       :</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    Remote IP       : REDACTED</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    Exclude suffixes: [.</span><span style="color: var(--shiki-token-keyword)">arpa</span><span style="color: var(--shiki-color-text)"> .</span><span style="color: var(--shiki-token-keyword)">com</span><span style="color: var(--shiki-color-text)"> .</span><span style="color: var(--shiki-token-keyword)">io</span><span style="color: var(--shiki-color-text)"> .</span><span style="color: var(--shiki-token-keyword)">net</span><span style="color: var(--shiki-color-text)"> .</span><span style="color: var(--shiki-token-keyword)">org</span><span style="color: var(--shiki-color-text)"> .</span><span style="color: var(--shiki-token-keyword)">ru</span><span style="color: var(--shiki-color-text)">]</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    Include suffixes: []</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    Timeout         : 4s</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  Also Proxy : (</span><span style="color: var(--shiki-token-numeric)">0</span><span style="color: var(--shiki-color-text)"> subnets)</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  Never Proxy: (</span><span style="color: var(--shiki-token-numeric)">1</span><span style="color: var(--shiki-color-text)"> subnets)</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">User Daemon: Running</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  Version           : v2.</span><span style="color: var(--shiki-token-numeric)">4.9</span><span style="color: var(--shiki-color-text)"> (api </span><span style="color: var(--shiki-token-numeric)">3</span><span style="color: var(--shiki-color-text)">)</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  Ambassador Cloud  : Logged out</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  Status            : Connected</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  Kubernetes server : REDACTED</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  Kubernetes context: REDACTED</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  Telepresence proxy: ON (networking to the cluster is enabled)</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  Intercepts        : </span><span style="color: var(--shiki-token-numeric)">0</span><span style="color: var(--shiki-color-text)"> total</span></span></code></pre>
<p>3) Telepresence requires a <code>Deployment</code>, as interception target, so instead of relying on the real controller deployment, let’s create a compatible mock:</p>
<pre class="shiki language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ kubectl create deployment webhook </span><span style="color: var(--shiki-token-symbol)">--</span><span style="color: var(--shiki-color-text)">image</span><span style="color: var(--shiki-token-symbol)">=</span><span style="color: var(--shiki-color-text)">k8s.gcr.io</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">echoserver:</span><span style="color: var(--shiki-token-numeric)">1.10</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-symbol)">--</span><span style="color: var(--shiki-color-text)">port </span><span style="color: var(--shiki-token-numeric)">9443</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">$ kubectl set selector svc webhook</span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">service app</span><span style="color: var(--shiki-token-symbol)">=</span><span style="color: var(--shiki-color-text)">webhook</span></span></code></pre>
<p>4) Intercept the webhook service:</p>
<pre class="shiki language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ telepresence intercept webhook </span><span style="color: var(--shiki-token-symbol)">--</span><span style="color: var(--shiki-color-text)">service webhook</span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">service </span><span style="color: var(--shiki-token-symbol)">--</span><span style="color: var(--shiki-color-text)">port </span><span style="color: var(--shiki-token-numeric)">9443</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-color-text)">Using Deployment webhook</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">intercepted</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    Intercept name    : webhook</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    State             : ACTIVE</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    Workload kind     : Deployment</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    Destination       : </span><span style="color: var(--shiki-token-numeric)">127.0</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-numeric)">0.1</span><span style="color: var(--shiki-color-text)">:</span><span style="color: var(--shiki-token-numeric)">9443</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    Volume Mount Error: sshfs is not installed on your local machine</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    Intercepting      : all TCP connections</span></span></code></pre>
<p>5) Generate the webhook server certificate, as the API server mandates HTTPS:</p>
<pre class="shiki language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-token-comment); font-style: italic"># Generate the CA certificate</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">$ openssl req </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">new </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">x509 </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">nodes </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">days </span><span style="color: var(--shiki-token-numeric)">365</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">keyout ca.key </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">out ca.crt </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">subj </span><span style="color: var(--shiki-token-string)">&quot;/CN=webhook&quot;</span></span>
<span class="line"><span style="color: var(--shiki-token-comment); font-style: italic"># Generate the webhook server certificate</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">$ openssl req </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">nodes </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">new </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">sha256 </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">keyout tls.key </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">out tls.csr </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">subj </span><span style="color: var(--shiki-token-string)">&quot;/CN=webhook-service.webhook.svc&quot;</span><span style="color: var(--shiki-color-text)"> \</span></span>
<span class="line"><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">config &lt;(cat </span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">etc</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">ssl</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">openssl.cnf &lt;(printf </span><span style="color: var(--shiki-token-string)">&quot;[SAN]\nsubjectAltName=DNS:webhook-service.webhook.svc&quot;</span><span style="color: var(--shiki-color-text)">)) </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">reqexts SAN</span></span>
<span class="line"><span style="color: var(--shiki-token-comment); font-style: italic"># Sign the server certificate with the generated CA</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">$ openssl x509 </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">req </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">days </span><span style="color: var(--shiki-token-numeric)">365</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-symbol)">-in</span><span style="color: var(--shiki-color-text)"> tls.csr </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">out tls.crt </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">CA ca.crt </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">CAkey ca.key </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">CAcreateserial \</span></span>
<span class="line"><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">extfile &lt;(cat </span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">etc</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">ssl</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">openssl.cnf &lt;(printf </span><span style="color: var(--shiki-token-string)">&quot;[SAN]\nsubjectAltName=DNS:webhook-service.webhook.svc&quot;</span><span style="color: var(--shiki-color-text)">)) </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">extensions SAN</span></span></code></pre>
<p>6) Patch the <code>MutatingWebhookConfiguration</code> resource, to set the <code>caBundle</code> field with the generated CA certificate:</p>
<pre class="shiki language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ kubectl patch mutatingwebhookconfiguration mutating</span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">webhook</span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">configuration </span><span style="color: var(--shiki-token-symbol)">--</span><span style="color: var(--shiki-color-text)">type</span><span style="color: var(--shiki-token-symbol)">=</span><span style="color: var(--shiki-token-string)">&#39;json&#39;</span><span style="color: var(--shiki-color-text)"> \</span></span>
<span class="line"><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">p</span><span style="color: var(--shiki-token-symbol)">=</span><span style="color: var(--shiki-token-string)">&quot;[{&#39;op&#39;: &#39;add&#39;, &#39;path&#39;: &#39;/webhooks/0/clientConfig/caBundle&#39;, &#39;value&#39;:&#39;</span><span style="color: var(--shiki-token-keyword)">$(</span><span style="color: var(--shiki-color-text)">cat ca.crt | base64 | tr </span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">d </span><span style="color: var(--shiki-token-string)">&#39;\n&#39;</span><span style="color: var(--shiki-token-keyword)">)</span><span style="color: var(--shiki-token-string)">&#39;}]&quot;</span></span></code></pre>
<p>7) Update the controller manager, to source certificates from the project directory:</p>
<pre class="shiki language-go"><code tabindex="0"><span class="line"><span style="color: var(--shiki-token-variable)">mgr</span><span style="color: var(--shiki-color-text)">, </span><span style="color: var(--shiki-token-variable)">err</span><span style="color: var(--shiki-color-text)"> </span><span style="color: #E5C07B">:=</span><span style="color: var(--shiki-color-text)"> ctrl.</span><span style="color: var(--shiki-token-symbol)">NewManager</span><span style="color: var(--shiki-color-text)">(ctrl.</span><span style="color: var(--shiki-token-symbol)">GetConfigOrDie</span><span style="color: var(--shiki-color-text)">(), ctrl.Options{</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">	CertDir: </span><span style="color: var(--shiki-token-string)">&quot;.&quot;</span><span style="color: var(--shiki-color-text)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">	</span><span style="color: var(--shiki-token-comment); font-style: italic">// ...</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">})</span></span></code></pre>
<p>8) Start the admission controller:</p>
<pre class="shiki language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ go run main.go</span></span></code></pre>
<p>9) Create a sample <code>Hooked</code> resource:</p>
<pre class="shiki language-ps1"><code tabindex="0"><span class="line"><span style="color: var(--shiki-color-text)">$ kubectl apply </span><span style="color: var(--shiki-color-text)">-f</span><span style="color: var(--shiki-color-text)"> config</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">samples</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">_v1_hooked.yaml</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">hooked.my.domain</span><span style="color: var(--shiki-token-symbol)">/</span><span style="color: var(--shiki-color-text)">hooked</span><span style="color: var(--shiki-token-symbol)">-</span><span style="color: var(--shiki-color-text)">sample created</span></span></code></pre>
<p>10) Check the admission controller output:</p>
<pre class="shiki language-json"><code tabindex="0"><span class="line"><span style="color: var(--shiki-token-numeric)">2021-12-23</span><span style="color: var(--shiki-color-text)">T</span><span style="color: var(--shiki-token-numeric)">15</span><span style="color: var(--shiki-color-text)">:</span><span style="color: var(--shiki-token-numeric)">03</span><span style="color: var(--shiki-color-text)">:</span><span style="color: var(--shiki-token-numeric)">08.088</span><span style="color: var(--shiki-color-text)">+</span><span style="color: var(--shiki-token-numeric)">0100</span><span style="color: var(--shiki-color-text)">	DEBUG	controller-runtime.webhook.webhooks	received request	{</span><span style="color: var(--shiki-token-parameter)">&quot;webhook&quot;</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">&quot;/mutate-my-domain-v1-hooked&quot;</span><span style="color: var(--shiki-color-text)">, </span><span style="color: var(--shiki-token-parameter)">&quot;UID&quot;</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">&quot;528ccce7-6404-499d-8959-42e620a211a4&quot;</span><span style="color: var(--shiki-color-text)">, </span><span style="color: var(--shiki-token-parameter)">&quot;kind&quot;</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">&quot;my.domain/v1, Kind=Hooked&quot;</span><span style="color: var(--shiki-color-text)">, </span><span style="color: var(--shiki-token-parameter)">&quot;resource&quot;</span><span style="color: var(--shiki-color-text)">: {</span><span style="color: var(--shiki-token-parameter)">&quot;group&quot;</span><span style="color: var(--shiki-color-text)">:</span><span style="color: var(--shiki-token-string)">&quot;my.domain&quot;</span><span style="color: var(--shiki-color-text)">,</span><span style="color: var(--shiki-token-parameter)">&quot;version&quot;</span><span style="color: var(--shiki-color-text)">:</span><span style="color: var(--shiki-token-string)">&quot;v1&quot;</span><span style="color: var(--shiki-color-text)">,</span><span style="color: var(--shiki-token-parameter)">&quot;resource&quot;</span><span style="color: var(--shiki-color-text)">:</span><span style="color: var(--shiki-token-string)">&quot;hookeds&quot;</span><span style="color: var(--shiki-color-text)">}}</span></span>
<span class="line"><span style="color: var(--shiki-token-numeric)">2021-12-23</span><span style="color: var(--shiki-color-text)">T</span><span style="color: var(--shiki-token-numeric)">15</span><span style="color: var(--shiki-color-text)">:</span><span style="color: var(--shiki-token-numeric)">03</span><span style="color: var(--shiki-color-text)">:</span><span style="color: var(--shiki-token-numeric)">08.088</span><span style="color: var(--shiki-color-text)">+</span><span style="color: var(--shiki-token-numeric)">0100</span><span style="color: var(--shiki-color-text)">	INFO	hooked-resource	default	{</span><span style="color: var(--shiki-token-parameter)">&quot;name&quot;</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">&quot;hooked-sample&quot;</span><span style="color: var(--shiki-color-text)">}</span></span>
<span class="line"><span style="color: var(--shiki-token-numeric)">2021-12-23</span><span style="color: var(--shiki-color-text)">T</span><span style="color: var(--shiki-token-numeric)">15</span><span style="color: var(--shiki-color-text)">:</span><span style="color: var(--shiki-token-numeric)">03</span><span style="color: var(--shiki-color-text)">:</span><span style="color: var(--shiki-token-numeric)">08.088</span><span style="color: var(--shiki-color-text)">+</span><span style="color: var(--shiki-token-numeric)">0100</span><span style="color: var(--shiki-color-text)">	DEBUG	controller-runtime.webhook.webhooks	wrote response	{</span><span style="color: var(--shiki-token-parameter)">&quot;webhook&quot;</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">&quot;/mutate-my-domain-v1-hooked&quot;</span><span style="color: var(--shiki-color-text)">, </span><span style="color: var(--shiki-token-parameter)">&quot;code&quot;</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-numeric)">200</span><span style="color: var(--shiki-color-text)">, </span><span style="color: var(--shiki-token-parameter)">&quot;reason&quot;</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">&quot;&quot;</span><span style="color: var(--shiki-color-text)">, </span><span style="color: var(--shiki-token-parameter)">&quot;UID&quot;</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-string)">&quot;528ccce7-6404-499d-8959-42e620a211a4&quot;</span><span style="color: var(--shiki-color-text)">, </span><span style="color: var(--shiki-token-parameter)">&quot;allowed&quot;</span><span style="color: var(--shiki-color-text)">: </span><span style="color: var(--shiki-token-constant)">true</span><span style="color: var(--shiki-color-text)">}</span></span></code></pre>
<p>Hooray, the admission controller running locally is called!</p>
<p>Happy coding!</p></main>

<footer><p>Copyright © <a href="https://github.com/astefanutti">Antonin Stefanutti</a>, 2023</p>
</footer>


			
			<script>
				{
					__sveltekit_1hopjh4 = {
						base: new URL(".", location).pathname.slice(0, -1),
						env: {}
					};

					const element = document.currentScript.parentElement;

					const data = [null,null];

					Promise.all([
						import("./_app/immutable/entry/start.00b47e61.js"),
						import("./_app/immutable/entry/app.22c486c8.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 3],
							data,
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
</body>

</html>
